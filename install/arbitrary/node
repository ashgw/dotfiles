#!/usr/bin/env bash
set -Eeuo pipefail

export DEBIAN_FRONTEND=noninteractive
export NEEDRESTART_MODE=a

GREEN="\e[1;32m"; CYAN="\e[36m"; RED="\e[31m"; YEL="\e[33m"; END="\e[0m"
say(){  printf "%b%s%b\n" "$CYAN" "$*" "$END"; }
ok(){   printf "%b%s%b\n" "$GREEN" "$*" "$END"; }
warn(){ printf "%b%s%b\n" "$YEL" "$*" "$END"; }
err(){  printf "%b%s%b\n" "$RED" "$*" "$END" >&2; }
trap 'err "failed at line $LINENO: $BASH_COMMAND"' ERR

have(){ command -v "$1" >/dev/null 2>&1; }

# ==========================================================
# Install Node.js 20 system-wide
# ==========================================================
install_node20_systemwide() {
  if have node; then
    version=$(node -v | sed 's/v\([0-9]\+\).*/\1/')
    if [ "$version" -eq 20 ]; then
      ok "System Node.js is already v$(node -v)."
      return
    else
      warn "Found Node.js $(node -v), replacing with Node.js 20..."
    fi
  else
    say "Node.js not found, installing Node.js 20 system-wide..."
  fi

  curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
  sudo apt-get install -y nodejs
  ok "Installed system-wide Node.js v$(node -v)."
}

# ==========================================================
# Install NVM + Node.js 20 via NVM
# ==========================================================
install_nvm() {
  if [ ! -d "$HOME/.nvm" ]; then
    say "Installing NVM..."
    curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.7/install.sh | bash
  else
    ok "NVM already installed."
  fi

  export NVM_DIR="$HOME/.nvm"
  [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"

  if ! nvm ls 20 >/dev/null 2>&1; then
    say "Installing Node.js 20 with NVM..."
    nvm install 20
  else
    ok "NVM already has Node.js 20."
  fi

  nvm alias default 20
  ok "NVM default set to Node.js 20."
}

# ==========================================================
# Entrypoint
# ==========================================================
install_node20_systemwide
install_nvm

