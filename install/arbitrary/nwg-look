#!/usr/bin/zsh
set -euo pipefail

# ---------- logging ----------
GREEN="\e[1;32m"; CYAN="\e[36m"; RED="\e[31m"; END="\e[0m"
say(){  printf "%b%s%b\n" "$CYAN" "$*" "$END"; }
ok(){   printf "%b%s%b\n" "$GREEN" "$*" "$END"; }
err(){  printf "%b%s%b\n" "$RED" "$*" "$END" >&2; }
trap 'err "failed at line $LINENO: $BASH_COMMAND"' ERR

# ---------- helpers ----------
need_pkg() {
  if ! dpkg -s "$1" >/dev/null 2>&1; then
    say "Installing missing dep: $1"
    sudo apt-get install -y "$1"
  else
    ok "Dependency already installed: $1"
  fi
}

# ---------- main ----------
say "Updating package lists..."
sudo apt-get update -y

# Build deps
for pkg in git build-essential libgtk-3-dev libgtk-layer-shell-dev libglib2.0-dev; do
  need_pkg "$pkg"
done

# Install nwg-look if missing
if command -v nwg-look >/dev/null 2>&1; then
  ok "nwg-look already installed at $(command -v nwg-look)"
else
  tmpdir=$(mktemp -d)
  say "Cloning nwg-look into $tmpdir"
  git clone --depth 1 https://github.com/nwg-piotr/nwg-look.git "$tmpdir"

  cd "$tmpdir"
  say "Building nwg-look..."
  make build

  say "Installing nwg-look..."
  sudo make install

  cd -
  rm -rf "$tmpdir"
  ok "nwg-look installed successfully!"
fi

