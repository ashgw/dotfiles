#!/usr/bin/env bash
set -Eeuo pipefail

DEB_URL="https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb"
DL_DIR="$HOME/Downloads"
DEB_PATH="$DL_DIR/$(basename "$DEB_URL")"
REAL_BIN="/opt/google/chrome/google-chrome"
LINK_BIN="/usr/local/bin/google-chrome"

need() { command -v "$1" >/dev/null 2>&1 || { echo "Missing: $1"; exit 1; }; }

[[ "$(id -u)" -ne 0 ]] || { echo "Do not run as root. It will sudo when needed."; exit 1; }
need sudo
need apt
need curl

install_chrome_if_missing() {
  if [[ -x "$REAL_BIN" ]]; then
    echo "[info] Chrome already present at $REAL_BIN"
    return
  fi
  echo "[info] Chrome not found. Downloading package to $DL_DIR"
  mkdir -p "$DL_DIR"
  curl -fsSL "$DEB_URL" -o "$DEB_PATH"

  echo "[info] Installing .deb with apt to resolve dependencies"
  sudo apt update
  if ! sudo apt install -y "$DEB_PATH"; then
    echo "[warn] apt direct install failed. Falling back to dpkg + fix"
    need dpkg
    sudo dpkg -i "$DEB_PATH" || true
    sudo apt -y -f install
  fi

  if [[ ! -x "$REAL_BIN" ]]; then
    echo "[error] Install finished but $REAL_BIN not found. Abort."
    exit 1
  fi
}

ensure_symlink() {
  echo "[info] Linking $LINK_BIN -> $REAL_BIN"
  sudo mkdir -p "$(dirname "$LINK_BIN")"
  if [[ -e "$LINK_BIN" || -L "$LINK_BIN" ]]; then
    sudo rm -f "$LINK_BIN"
  fi
  sudo ln -s "$REAL_BIN" "$LINK_BIN"
}

verify() {
  echo "[info] Verifying"
  command -v google-chrome || true
  "$REAL_BIN" --version || true
  "$LINK_BIN" --version || true
}

install_chrome_if_missing
ensure_symlink
verify
echo "[done] Run: google-chrome"

