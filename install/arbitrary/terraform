#!/bin/bash

set -euo pipefail

# Ensure dependencies
sudo apt-get update -y
sudo apt-get install -y gnupg curl software-properties-common

# Add HashiCorp GPG key and repo (idempotent)
if [ ! -f /usr/share/keyrings/hashicorp-archive-keyring.gpg ]; then
	curl -fsSL https://apt.releases.hashicorp.com/gpg | gpg --dearmor | sudo tee /usr/share/keyrings/hashicorp-archive-keyring.gpg >/dev/null
fi

if ! grep -Rqs "^deb .*apt.releases.hashicorp.com" /etc/apt/sources.list /etc/apt/sources.list.d 2>/dev/null; then
	echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(. /etc/os-release && echo $VERSION_CODENAME) main" | sudo tee /etc/apt/sources.list.d/hashicorp.list >/dev/null
fi

sudo apt-get update -y
sudo apt-get install -y terraform

# terraform version manager (optional)
if [ ! -d "$HOME/.tfenv" ]; then
	git clone --depth=1 https://github.com/tfutils/tfenv.git "$HOME/.tfenv"
	if ! grep -q 'export PATH="$HOME/.tfenv/bin:$PATH"' "$HOME/.zshrc" 2>/dev/null; then
		echo 'export PATH="$HOME/.tfenv/bin:$PATH"' >> "$HOME/.zshrc"
	fi
fi
